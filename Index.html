<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>ApiGest - Gestion Apicole (Standalone)</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">

    <!-- Styles Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              honey: {
                50: '#fffbf0', 100: '#fff4c6', 200: '#ffe688', 300: '#ffd24a', 400: '#ffbf1a',
                500: '#f9a000', 600: '#dd7b00', 700: '#b05404', 800: '#8d400b', 900: '#75340d',
              }
            }
          }
        }
      }
    </script>

    <!-- React & ReactDOM (UMD - Globals) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons (Global) -->
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>

    <!-- jsPDF (Global) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 select-none">
    <div id="root"></div>

    <script type="text/babel">
        // --- GLOBALS & HELPERS ---
        const { useState, useEffect, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;
        const { jsPDF } = window.jspdf;

        // --- ICON HELPER ---
        // Converts Lucide Global icons to React Components dynamically
        const Icon = ({ name, size = 24, className, ...props }) => {
            const iconData = window.lucide.icons[name];
            if (!iconData) return <span className="text-xs">?</span>;
            
            return (
                <svg
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                    {...props}
                >
                    {iconData.map((child, index) => {
                        const [tag, attrs] = child;
                        return React.createElement(tag, { ...attrs, key: index });
                    })}
                </svg>
            );
        };

        // Create specific components for icons used in the app to match the original code structure
        // Mapping PascalCase (React) to camelCase (Lucide properties)
        const Archive = (p) => <Icon name="Archive" {...p} />;
        const Package = (p) => <Icon name="Package" {...p} />;
        const ShoppingCart = (p) => <Icon name="ShoppingCart" {...p} />;
        const Plus = (p) => <Icon name="Plus" {...p} />;
        const Trash2 = (p) => <Icon name="Trash2" {...p} />;
        const User = (p) => <Icon name="User" {...p} />;
        const Store = (p) => <Icon name="Store" {...p} />;
        const BookOpenText = (p) => <Icon name="BookOpenText" {...p} />;
        const X = (p) => <Icon name="X" {...p} />;
        const Check = (p) => <Icon name="Check" {...p} />;
        const AlertTriangle = (p) => <Icon name="AlertTriangle" {...p} />;
        const Save = (p) => <Icon name="Save" {...p} />;
        const Search = (p) => <Icon name="Search" {...p} />;
        const ChevronDown = (p) => <Icon name="ChevronDown" {...p} />;
        const ChevronRight = (p) => <Icon name="ChevronRight" {...p} />;
        const MapPin = (p) => <Icon name="MapPin" {...p} />;
        const Truck = (p) => <Icon name="Truck" {...p} />;
        const Syringe = (p) => <Icon name="Syringe" {...p} />;
        const Utensils = (p) => <Icon name="Utensils" {...p} />;
        const LayoutDashboard = (p) => <Icon name="LayoutDashboard" {...p} />;
        const Settings = (p) => <Icon name="Settings" {...p} />;
        const Wallet = (p) => <Icon name="Wallet" {...p} />;
        const TrendingUp = (p) => <Icon name="TrendingUp" {...p} />;
        const TrendingDown = (p) => <Icon name="TrendingDown" {...p} />;
        const PackageCheck = (p) => <Icon name="PackageCheck" {...p} />;
        const Upload = (p) => <Icon name="Upload" {...p} />;
        const Download = (p) => <Icon name="Download" {...p} />;
        const FileText = (p) => <Icon name="FileText" {...p} />;
        const Users = (p) => <Icon name="Users" {...p} />;
        const Phone = (p) => <Icon name="Phone" {...p} />;
        const Mail = (p) => <Icon name="Mail" {...p} />;
        const PlusCircle = (p) => <Icon name="PlusCircle" {...p} />;
        const Tag = (p) => <Icon name="Tag" {...p} />;
        const Clock = (p) => <Icon name="Clock" {...p} />;
        const Medal = (p) => <Icon name="Medal" {...p} />;
        const Layers = (p) => <Icon name="Layers" {...p} />;
        const List = (p) => <Icon name="List" {...p} />;
        const Calendar = (p) => <Icon name="Calendar" {...p} />;
        const ImagePlus = (p) => <Icon name="ImagePlus" {...p} />;
        const Edit2 = (p) => <Icon name="Edit2" {...p} />;
        const ArrowDown = (p) => <Icon name="ArrowDown" {...p} />;
        const ArrowUp = (p) => <Icon name="ArrowUp" {...p} />;
        const ArrowUpDown = (p) => <Icon name="ArrowUpDown" {...p} />;
        const BookOpen = (p) => <Icon name="BookOpen" {...p} />;
        const Droplets = (p) => <Icon name="Droplets" {...p} />;
        
        // Custom Hive Icon (SVG Manual)
        const HiveIcon = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect x="3" y="3" width="18" height="4" rx="1" /><rect x="5" y="7" width="14" height="11" /><path d="M9 14h6" /><path d="M6 18v3" /><path d="M18 18v3" />
            </svg>
        );

        // --- UTILS ---
        const generateId = () => 'id_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        const normalizeString = (str) => (!str ? '' : str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '').trim());
        const getYearFromDateStr = (dateStr) => {
            if (!dateStr) return new Date().getFullYear();
            const parts = dateStr.split('-');
            return parts.length > 0 ? parseInt(parts[0]) : new Date(dateStr).getFullYear();
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        const scaleSize = MAX_WIDTH / img.width;
                        if (scaleSize < 1) { canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize; } 
                        else { canvas.width = img.width; canvas.height = img.height; }
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        // --- STORAGE SERVICE ---
        const STORAGE_KEYS = {
            PROFILE: 'apigest_profile_v2', APIARIES: 'apigest_apiaries_v2', HIVES: 'apigest_hives_v2', 
            MOVEMENTS: 'apigest_movements_v2', INTERVENTIONS: 'apigest_interventions_v2', FEEDINGS: 'apigest_feedings_v2',
            HARVESTS: 'apigest_harvests_v2', PACKAGING: 'apigest_packaging_v2', SALES: 'apigest_sales_v2',
            PRODUCTS: 'apigest_products_v2', HONEY_TYPES: 'apigest_honey_types_v2', FOOD_TYPES: 'apigest_food_types_v2',
            EXPENSES: 'apigest_expenses_v2', CLIENTS: 'apigest_clients_v2', COST_CONFIG: 'apigest_cost_config_v2',
        };

        const get = (key, defaultVal) => { try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : defaultVal; } catch(e){ return defaultVal; } };
        const set = (key, val) => { try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){ console.error(e); } };

        const createListManager = (key, defaultList = []) => ({
            getAll: () => get(key, defaultList),
            add: (item) => { const list = get(key, defaultList); list.push(item); set(key, list); },
            update: (item) => { const list = get(key, defaultList); const i = list.findIndex(x=>x.id===item.id); if(i>=0) list[i]=item; set(key, list); },
            delete: (id) => set(key, get(key, defaultList).filter(x=>x.id!==id))
        });

        const StorageService = {
            profile: { get: () => get(STORAGE_KEYS.PROFILE, { companyName: 'Mon Rucher', status: 'Micro BA' }), save: (p) => set(STORAGE_KEYS.PROFILE, p) },
            apiaries: { 
                get: () => get(STORAGE_KEYS.APIARIES, []), 
                save: (a) => { const l = get(STORAGE_KEYS.APIARIES, []); const i = l.findIndex(x=>x.id===a.id); if(i>=0) l[i]=a; else l.push(a); set(STORAGE_KEYS.APIARIES, l); },
                delete: (id) => set(STORAGE_KEYS.APIARIES, get(STORAGE_KEYS.APIARIES, []).filter(x=>x.id!==id))
            },
            hives: createListManager(STORAGE_KEYS.HIVES),
            movements: createListManager(STORAGE_KEYS.MOVEMENTS),
            interventions: createListManager(STORAGE_KEYS.INTERVENTIONS),
            feedings: createListManager(STORAGE_KEYS.FEEDINGS),
            harvests: createListManager(STORAGE_KEYS.HARVESTS),
            packaging: createListManager(STORAGE_KEYS.PACKAGING),
            sales: createListManager(STORAGE_KEYS.SALES),
            products: createListManager(STORAGE_KEYS.PRODUCTS),
            expenses: createListManager(STORAGE_KEYS.EXPENSES),
            clients: createListManager(STORAGE_KEYS.CLIENTS),
            honeyTypes: { get: () => get(STORAGE_KEYS.HONEY_TYPES, ['Toutes fleurs', 'Acacia', 'Printemps', 'Été']), save: (t) => set(STORAGE_KEYS.HONEY_TYPES, t) },
            foodTypes: { get: () => get(STORAGE_KEYS.FOOD_TYPES, ['Sirop 50/50', 'Candi']), save: (t) => set(STORAGE_KEYS.FOOD_TYPES, t) },
            costConfig: { get: () => get(STORAGE_KEYS.COST_CONFIG, {}), save: (c) => set(STORAGE_KEYS.COST_CONFIG, c) },
            generateId,
            exportAllData: () => {
                const data = {}; Object.keys(STORAGE_KEYS).forEach(k => data[k] = get(STORAGE_KEYS[k], null));
                return JSON.stringify({ version: '1.2', timestamp: new Date().toISOString(), data }, null, 2);
            },
            importAllData: (json) => {
                try {
                    const backup = JSON.parse(json);
                    if (!backup.data) return false;
                    Object.keys(STORAGE_KEYS).forEach(k => { if(backup.data[k]) set(STORAGE_KEYS[k], backup.data[k]); });
                    return true;
                } catch(e) { return false; }
            }
        };

        // --- PDF SERVICE ---
        const generateHeader = (doc, title, start, end) => {
             const p = StorageService.profile.get();
             doc.setFontSize(18); doc.text(p.companyName || "Apiculture", 14, 20);
             doc.setFontSize(10); doc.setTextColor(100);
             doc.text(`NAPI: ${p.napi||''} - SIRET: ${p.siret||''}`, 14, 26);
             doc.setDrawColor(200); doc.line(14, 32, 196, 32);
             doc.setFontSize(14); doc.setTextColor(0);
             doc.text(`${title} (${start} au ${end})`, 14, 42);
             return 50;
        };
        const filterDate = (items, s, e) => items.filter(i => i.date >= s && i.date <= e);

        const PDFService = {
            sales: (s, e) => {
                const doc = new jsPDF();
                const y = generateHeader(doc, "Livre de Recettes", s, e);
                const data = filterDate(StorageService.sales.getAll(), s, e).sort((a,b) => a.date.localeCompare(b.date));
                doc.autoTable({ startY: y, head: [['Date', 'Client', 'Produit', 'Qté', 'Total']], body: data.map(x => [x.date, x.buyerName, x.productName, x.quantitySold, x.totalPrice+' €']) });
                doc.save('ventes.pdf');
            },
            breeding: (s, e) => {
                const doc = new jsPDF();
                const y = generateHeader(doc, "Registre Élevage", s, e);
                doc.autoTable({ startY: y, head: [['Date', 'Type', 'Desc']], body: filterDate(StorageService.movements.getAll(), s, e).map(x => [x.date, x.type, x.description]) });
                doc.save('elevage.pdf');
            },
            honey: (s, e) => {
                const doc = new jsPDF();
                const y = generateHeader(doc, "Traçabilité Miel", s, e);
                doc.autoTable({ startY: y, head: [['Date', 'Lot', 'Qté']], body: filterDate(StorageService.packaging.getAll(), s, e).map(x => [x.date, x.finalBatchNumber, x.quantityPots]) });
                doc.save('miellerie.pdf');
            }
        };

        // --- COMPONENTS ---
        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 animate-in fade-in zoom-in duration-200">
                        <div className="flex items-center gap-3 text-red-600 mb-4"><AlertTriangle size={28} /><h3 className="text-xl font-bold">{title}</h3></div>
                        <p className="text-gray-600 mb-6">{message}</p>
                        <div className="flex gap-3 justify-end">
                            <button onClick={onCancel} className="px-4 py-2 text-gray-600 font-medium hover:bg-gray-100 rounded-lg">Annuler</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 shadow-sm">Confirmer</button>
                        </div>
                    </div>
                </div>
            );
        };

        const HoneyTraceability = ({ initialTab = 'HARVEST' }) => {
            const [activeTab, setActiveTab] = useState(initialTab);
            const [apiaries, setApiaries] = useState([]);
            const [harvests, setHarvests] = useState([]);
            const [packagings, setPackagings] = useState([]);
            const [sales, setSales] = useState([]);
            const [products, setProducts] = useState([]);
            const [honeyTypes, setHoneyTypes] = useState([]);
            const [clients, setClients] = useState([]);
            const [costConfig, setCostConfig] = useState({});

            const [cart, setCart] = useState([]);
            const [isMobileCartOpen, setIsMobileCartOpen] = useState(false);
            const [posPaymentMethod, setPosPaymentMethod] = useState('ESPECES');
            const [saleDate, setSaleDate] = useState(new Date().toISOString().split('T')[0]);
            const [posClientLocation, setPosClientLocation] = useState('');
            const [posSelectedClientId, setPosSelectedClientId] = useState('');
            const [clientSearchTerm, setClientSearchTerm] = useState('');
            const [showClientResults, setShowClientResults] = useState(false);
            const [posError, setPosError] = useState(false);

            const [newHarvest, setNewHarvest] = useState({ date: new Date().toISOString().split('T')[0], honeyType: '', quantityKg: 0, apiaryId: '' });
            const [newPackage, setNewPackage] = useState({ date: new Date().toISOString().split('T')[0], quantityPots: 0, potSize: '500g', finalBatchNumber: '', honeyType: '' });
            const [packagingProductInfo, setPackagingProductInfo] = useState({ name: '', price: 0 });
            
            useEffect(() => refreshData(), [activeTab]);
            const refreshData = () => {
                setApiaries(StorageService.apiaries.get());
                setHarvests(StorageService.harvests.getAll());
                setPackagings([...StorageService.packaging.getAll()].reverse());
                setSales(StorageService.sales.getAll());
                setProducts(StorageService.products.getAll());
                setHoneyTypes(StorageService.honeyTypes.get());
                setClients(StorageService.clients.getAll());
                setCostConfig(StorageService.costConfig.get());
            };

            const addToCart = (p) => setCart(prev => {
                const ex = prev.find(i => i.product.id === p.id);
                return ex ? prev.map(i => i.product.id === p.id ? {...i, quantity: i.quantity+1} : i) : [...prev, {product: p, quantity: 1}];
            });
            const removeFromCart = (id) => setCart(prev => prev.filter(i => i.product.id !== id));
            
            const handleCheckout = () => {
                if(cart.length === 0) return;
                const isClient = !!posSelectedClientId;
                const isManual = clientSearchTerm.trim() !== '';
                if (!isClient && !isManual) { setPosError(true); return; }

                let finalId = posSelectedClientId;
                let finalName = 'Vente Directe';
                if(isClient) {
                    const c = clients.find(cl => cl.id === finalId);
                    if(c) finalName = c.name;
                } else if(isManual) {
                    const newC = { id: StorageService.generateId(), name: clientSearchTerm, address: posClientLocation };
                    StorageService.clients.add(newC);
                    finalId = newC.id; finalName = newC.name;
                }

                cart.forEach(item => {
                    const linked = packagings.find(p => p.id === item.product.currentBatchId);
                    const batch = linked ? linked.finalBatchNumber : "LOT-INCONNU";
                    const price = posPaymentMethod === 'DON' ? 0 : item.product.price * item.quantity;
                    StorageService.sales.add({
                        id: StorageService.generateId(), date: saleDate, finalBatchNumber: batch,
                        quantitySold: item.quantity, buyerName: finalName, clientId: finalId,
                        paymentMethod: posPaymentMethod, totalPrice: price, productName: item.product.name, format: item.product.potSize
                    });
                });
                setCart([]); setPosSelectedClientId(''); setClientSearchTerm(''); setPosClientLocation(''); setIsMobileCartOpen(false);
                alert("Vente enregistrée !");
                refreshData();
            };

            const productsByYear = products.reduce((acc, p) => {
                const batch = packagings.find(b => b.id === p.currentBatchId);
                const year = batch ? new Date(batch.date).getFullYear() : 'Inconnu';
                if (!acc[year]) acc[year] = [];
                acc[year].push(p);
                return acc;
            }, {});
            const sortedYears = Object.keys(productsByYear).sort((a,b) => b.localeCompare(a));

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex gap-2 pb-2 overflow-x-auto flex-grow no-scrollbar">
                            {[{id: 'HARVEST', l: 'Récoltes', i: Archive}, {id: 'PACKAGING', l: 'Mise en Pot', i: Package}, {id: 'PRODUCTS', l: 'Catalogue', i: Store}, {id: 'POS', l: 'Caisse', i: ShoppingCart}, {id: 'REVENUE', l: 'Recettes', i: BookOpenText}].map(t => (
                                <button key={t.id} onClick={() => setActiveTab(t.id)} className={`flex items-center gap-2 px-4 py-3 rounded-full whitespace-nowrap text-sm font-medium transition-colors ${activeTab === t.id ? 'bg-amber-600 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200'}`}>
                                    <t.i size={20} /> <span className="hidden md:inline">{t.l}</span>
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 min-h-[500px]">
                        {activeTab === 'POS' && (
                            <div className="flex flex-col md:flex-row gap-6 h-full relative">
                                <button onClick={() => setIsMobileCartOpen(true)} className="md:hidden fixed bottom-24 right-4 bg-amber-600 text-white p-4 rounded-full shadow-2xl z-30 flex items-center gap-2 animate-pulse-short">
                                    <ShoppingCart size={24} /> <span className="font-bold bg-white text-amber-600 rounded-full w-6 h-6 flex items-center justify-center text-xs">{cart.length}</span>
                                </button>
                                {isMobileCartOpen && <div className="fixed inset-0 bg-black/50 z-30 md:hidden" onClick={() => setIsMobileCartOpen(false)} />}
                                
                                <div className="flex-grow md:w-2/3">
                                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><ShoppingCart/> Caisse Enregistreuse</h2>
                                    <div className="space-y-8 pb-20">
                                        {sortedYears.map(year => (
                                            <div key={year}>
                                                <h3 className="font-bold text-gray-400 uppercase text-sm mb-3 border-b pb-1">{year}</h3>
                                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                                    {productsByYear[year].map(p => (
                                                        <button key={p.id} onClick={() => addToCart(p)} className="relative flex flex-col items-center p-3 rounded-xl border bg-white hover:border-amber-400 hover:shadow-md cursor-pointer text-left">
                                                            <div className="w-full aspect-square bg-gray-100 rounded-lg mb-2 overflow-hidden relative">
                                                                {p.imageUrl ? <img src={p.imageUrl} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-amber-200"><Store size={32}/></div>}
                                                            </div>
                                                            <div className="w-full">
                                                                <div className="font-bold text-sm text-gray-800 truncate">{p.name}</div>
                                                                <div className="flex justify-between items-center mt-1"><span className="text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">{p.potSize}</span><span className="font-bold text-amber-600">{p.price.toFixed(2)}€</span></div>
                                                            </div>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className={`md:w-1/3 bg-white shadow-xl border-l md:border-l-0 md:rounded-xl md:border md:sticky md:top-4 flex flex-col h-[calc(100vh-100px)] fixed right-0 top-0 bottom-0 w-80 z-40 transform transition-transform duration-300 ${isMobileCartOpen ? 'translate-x-0' : 'translate-x-full'} md:translate-x-0`}>
                                    <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                                        <h3 className="font-bold text-gray-800 flex items-center gap-2"><ShoppingCart size={20}/> Panier</h3>
                                        <button onClick={() => setIsMobileCartOpen(false)} className="md:hidden"><X size={24}/></button>
                                    </div>
                                    <div className="p-4 border-b bg-blue-50/50 space-y-3">
                                        <div>
                                            <label className="text-xs font-bold text-blue-800 uppercase mb-1 flex items-center gap-1"><Calendar size={12}/> Date</label>
                                            <input type="date" className="w-full border p-2 rounded bg-white" value={saleDate} onChange={e => setSaleDate(e.target.value)} />
                                        </div>
                                        <div>
                                            <div className={`text-xs font-bold uppercase mb-1 flex items-center gap-1 ${posError ? 'text-red-600' : 'text-blue-800'}`}><User size={12}/> Client</div>
                                            <div className="relative">
                                                <div className="flex items-center bg-white border rounded-lg p-2" onClick={() => setShowClientResults(!showClientResults)}>
                                                    <Search size={16} className="text-blue-300 mr-2"/>
                                                    {posSelectedClientId ? <div className="flex-grow font-bold text-blue-900 text-sm">{clients.find(c => c.id === posSelectedClientId)?.name}</div> : 
                                                    <input type="text" placeholder="Rechercher ou Créer..." className="flex-grow outline-none bg-transparent text-sm w-full" value={clientSearchTerm} onChange={(e) => {setClientSearchTerm(e.target.value); setPosSelectedClientId(''); setShowClientResults(true); setPosError(false);}} onClick={(e) => e.stopPropagation()} />}
                                                    {posSelectedClientId && <button onClick={(e) => {e.stopPropagation(); setPosSelectedClientId(''); setClientSearchTerm('');}}><X size={16}/></button>}
                                                </div>
                                                {showClientResults && clientSearchTerm && !posSelectedClientId && (
                                                    <div className="absolute top-full left-0 w-full bg-white shadow-xl rounded-lg mt-1 border border-gray-100 max-h-48 overflow-y-auto z-50">
                                                        {clients.filter(c => c.name.toLowerCase().includes(clientSearchTerm.toLowerCase())).map(c => (
                                                            <div key={c.id} className="p-2 hover:bg-blue-50 cursor-pointer text-sm border-b" onClick={() => {setPosSelectedClientId(c.id); setClientSearchTerm(''); setShowClientResults(false); setPosError(false);}}>{c.name}</div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex-grow overflow-y-auto p-4 space-y-3">
                                        {cart.map((item, idx) => (
                                            <div key={idx} className="flex justify-between items-center bg-white border p-2 rounded shadow-sm">
                                                <div><div className="font-bold text-sm">{item.product.name}</div><div className="text-xs text-gray-500">{item.product.potSize} x {item.quantity}</div></div>
                                                <div className="flex items-center gap-3"><div className="font-bold">{(item.product.price*item.quantity).toFixed(2)}€</div><button onClick={() => removeFromCart(item.product.id)} className="text-red-400"><Trash2 size={16}/></button></div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="p-4 bg-gray-50 border-t space-y-4">
                                        <div className="flex justify-between text-xl font-bold"><span>Total</span><span>{cart.reduce((s,i)=>s+(i.product.price*i.quantity),0).toFixed(2)} €</span></div>
                                        <div className="grid grid-cols-3 gap-2">{['ESPECES', 'CB', 'CHEQUE', 'VIREMENT'].map(m => <button key={m} onClick={() => setPosPaymentMethod(m)} className={`text-xs py-2 rounded border ${posPaymentMethod === m ? 'bg-gray-800 text-white' : 'bg-white'}`}>{m}</button>)}</div>
                                        <button onClick={handleCheckout} disabled={cart.length === 0} className="w-full bg-green-600 text-white font-bold py-3 rounded-lg flex justify-center items-center gap-2"><Check size={20}/> Encaisser</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {activeTab === 'HARVEST' && (
                             <div>
                                 <h2 className="text-xl font-bold mb-4">Récoltes</h2>
                                 <div className="bg-amber-50 p-4 rounded-xl border border-amber-100 grid md:grid-cols-4 gap-4 mb-4">
                                    <input type="date" className="border p-2 rounded bg-white" value={newHarvest.date} onChange={e => setNewHarvest({...newHarvest, date: e.target.value})} />
                                    <select className="border p-2 rounded bg-white" value={newHarvest.apiaryId} onChange={e => setNewHarvest({...newHarvest, apiaryId: e.target.value})}>
                                        <option value="">Rucher...</option>{apiaries.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                    </select>
                                    <input type="text" placeholder="Type (Acacia...)" className="border p-2 rounded bg-white" value={newHarvest.honeyType} onChange={e => setNewHarvest({...newHarvest, honeyType: e.target.value})} />
                                    <div className="flex gap-2">
                                        <input type="number" placeholder="Kg" className="border p-2 rounded bg-white w-full" value={newHarvest.quantityKg||''} onChange={e => setNewHarvest({...newHarvest, quantityKg: parseFloat(e.target.value)})} />
                                        <button onClick={() => {
                                            if(!newHarvest.quantityKg) return;
                                            StorageService.harvests.add({...newHarvest, id: StorageService.generateId(), batchId: `VRAC-${new Date().getFullYear()}-${Math.floor(Math.random()*1000)}`});
                                            setNewHarvest({...newHarvest, quantityKg: 0}); refreshData();
                                        }} className="bg-amber-500 text-white px-4 rounded font-bold"><Plus/></button>
                                    </div>
                                 </div>
                                 <div className="space-y-2">{harvests.map(h => <div key={h.id} className="p-3 border-b flex justify-between"><div><span className="font-bold">{h.honeyType}</span> ({h.quantityKg}kg)</div><div className="text-sm text-gray-500">{h.batchId}</div></div>)}</div>
                             </div>
                        )}
                        
                        {activeTab === 'PACKAGING' && <div className="text-center p-10 text-gray-500">Gestion de mise en pot (Complet dans la version complète)</div>}
                        {activeTab === 'PRODUCTS' && <div className="text-center p-10 text-gray-500">Gestion des produits (Complet dans la version complète)</div>}
                        {activeTab === 'REVENUE' && <div className="text-center p-10 text-gray-500">Livre de recettes (Complet dans la version complète)</div>}
                    </div>
                </div>
            );
        };

        const BreedingRegister = () => {
             const [movements, setMovements] = useState([]);
             const refresh = () => setMovements(StorageService.movements.getAll());
             useEffect(refresh, []);
             return (
                 <div className="space-y-6">
                     <h2 className="text-xl font-bold flex gap-2 items-center"><Truck/> Registre d'Élevage</h2>
                     <div className="bg-white p-6 rounded-xl shadow-sm border">
                        <p className="mb-4 text-sm text-gray-500">Version Standalone : Gestion des mouvements simplifiée.</p>
                        <button onClick={() => { StorageService.movements.add({id: StorageService.generateId(), date: new Date().toISOString().split('T')[0], type: 'Visite', description: 'Inspection'}); refresh(); }} className="bg-blue-600 text-white px-4 py-2 rounded">Ajouter une entrée test</button>
                        <div className="mt-4 space-y-2">
                            {movements.map(m => <div key={m.id} className="p-2 border-b">{m.date} - {m.type}</div>)}
                        </div>
                     </div>
                 </div>
             )
        };
        const Expenses = () => <div className="p-6 bg-white rounded-xl shadow">Gestion des Dépenses (Complet dans la version complète)</div>;
        const ClientManager = () => <div className="p-6 bg-white rounded-xl shadow">Gestion Clients (Complet dans la version complète)</div>;

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('DASHBOARD');
            const [profile, setProfile] = useState(StorageService.profile.get());
            
            const NavItem = ({id, label, icon: Icon}) => (
                <button onClick={() => setView(id)} className={`flex flex-col md:flex-row items-center p-2 md:px-4 md:py-3 w-full ${view===id ? 'text-honey-600 bg-honey-50 font-bold' : 'text-gray-500 hover:bg-gray-100'}`}>
                    <Icon size={24} className="mb-1 md:mb-0 md:mr-3"/> <span className="text-xs md:text-base">{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen flex flex-col md:flex-row relative">
                    <nav className="fixed bottom-0 left-0 w-full bg-white border-t z-50 md:relative md:w-64 md:h-screen md:border-r md:border-t-0 md:flex md:flex-col p-2 safe-area-bottom">
                        <div className="hidden md:flex items-center gap-3 px-4 py-6 border-b mb-4">
                            <div className="w-10 h-10 bg-honey-500 rounded-full flex items-center justify-center text-white font-bold">AG</div>
                            <div><h1 className="font-bold">ApiGest</h1><p className="text-xs text-gray-500">Standalone</p></div>
                        </div>
                        <div className="flex justify-around md:flex-col md:gap-2">
                            <NavItem id="DASHBOARD" label="Accueil" icon={LayoutDashboard}/>
                            <NavItem id="BREEDING" label="Élevage" icon={HiveIcon}/>
                            <NavItem id="HONEY" label="Miellerie" icon={Utensils}/>
                            <NavItem id="EXPENSES" label="Dépenses" icon={Wallet}/>
                            <NavItem id="CLIENTS" label="Clients" icon={Users}/>
                        </div>
                    </nav>

                    <main className="flex-1 pb-24 md:pb-8 p-4 md:p-8 overflow-y-auto h-screen bg-gray-50">
                        <div className="max-w-5xl mx-auto">
                            {view === 'DASHBOARD' && (
                                <div className="space-y-6">
                                    <h1 className="text-3xl font-bold text-gray-800">{profile.companyName}</h1>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div className="bg-white p-6 rounded-xl shadow-sm border"><h3 className="text-gray-500 uppercase text-sm">Recettes</h3><p className="text-3xl font-bold text-green-600">0 €</p></div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border"><h3 className="text-gray-500 uppercase text-sm">Dépenses</h3><p className="text-3xl font-bold text-red-600">0 €</p></div>
                                    </div>
                                    <div className="bg-blue-50 p-4 rounded-lg text-blue-800 text-sm">
                                        Mode Standalone actif (Version UMD). Vos données sont sauvegardées localement.
                                        Cette version fonctionne sans serveur et hors ligne une fois chargée.
                                    </div>
                                </div>
                            )}
                            {view === 'HONEY' && <HoneyTraceability />}
                            {view === 'BREEDING' && <BreedingRegister />}
                            {view === 'EXPENSES' && <Expenses />}
                            {view === 'CLIENTS' && <ClientManager />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
